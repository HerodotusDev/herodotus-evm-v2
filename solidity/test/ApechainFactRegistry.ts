import { ethers } from "hardhat";
import { expect } from "chai";
import {
  accountFields as af,
  accountFieldsBitmask as am,
  headerFields as hf,
  headerFieldsBitmask as hm,
  toU256,
  setMmrData,
  deploy,
  APECHAIN_SHARE_PRICE_ADDRESS,
  APECHAIN_SHARE_PRICE_SLOT,
} from "./utils";
import { loadFixture } from "@nomicfoundation/hardhat-network-helpers";

describe("EVM Fact Registry Apechain", () => {
  it("Should prove account", async () => {
    const { satellite, satelliteAddress } = await loadFixture(deploy);

    const chainId = BigInt(33111);
    const blockNumber = BigInt(0x104e821);
    const mmrId = BigInt(100);
    const mmrSize = BigInt(1);
    const keccakHasher = BigInt(
      "0xdf35a135a69c769066bbb4d17b2fa3ec922c028d4e4bf9d0402e6f7c12b31813",
    );
    const blockHash =
      "0xc0e31e50a113d30d36da432139080f5a596631f1935b1b37a4a1a905d1a1f290";
    const mmrRoot = BigInt(
      ethers.keccak256(toU256(mmrSize, BigInt(blockHash))),
    );

    await setMmrData(
      satelliteAddress,
      chainId,
      mmrId,
      keccakHasher,
      false,
      mmrSize,
      mmrRoot,
    );

    const account = "0xEEBC6016539E0bC60D35f527FEfa414794854499";
    const headerProof = {
      mmrId,
      mmrSize,
      mmrLeafIndex: 1,
      mmrPeaks: [blockHash],
      mmrInclusionProof: [],
      blockHeaderRlp:
        "0xf90223a0e09c933b2ae4b00ae29a6ce9ec40d2073f74cc1a39cd2453948a2945c8051680a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794a4b000000000000000000073657175656e636572a07da0dca81ff738751942f1e160e8bb174f2822b54271e048e30028e9f05d4f7ca05494efe03c9f501e7c8afc33f13af9304224f840d91a9608dabfedc43cd1fbb6a008519cd3f965720c9f16783ad2e6a3d2df9fa05d18ac58f8d0ade7dd8c5ec5c6b901000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000040000000000000000220000000000000000000000000000000000000200000000000000000000000000000000000000000002000000000000000004080000000000000000400000000004200000000000000000000000002000000041000000000000000000000022000000000000000000000000000000080000800000080000000000000000000000000000000000002000000000004000000000000400000000000000000000000000002000000000000000000000000800000000000000800000040000000000000010000001840104e8218704000000000000830129388467efcb0fa055197ad14d6804f2dcd9118ebd0cea13640510a635005d312d7dae2db30d96bfa000000000004430d200000000007ad0d7000000000000002000000000000000008800000000000d920883989680",
    };
    const accountTrieProof =
      "0xf90bb3b90214f90211a0e7615cc1a65525dcbe26e59fac6822fd3bd555af663c4c580bd8cef784c31536a0715132fc76d255fc7a8aebdf240b8568e33bed61fcbd13db95e057b25ee4199fa067eabbde6b28d98300186b627409c9c1d0c4f83d29aa9fca00657df26fb99b57a070c2526f2f783305f00a9559d780220e963e83b238d0b4c06604c36c6b6c139ea09849edeee1a769316786b848c5bfa444be3c568cff1d5985fc8b29f75258df6fa030fd041f6909484573737047e63792567e4daf95b93d98d60c70d3baed2990a4a09b620ab489dd1f05f4582f2dcfb387bcb632f1b5e8046486e1ee2c9ccc0a4c38a09ead1c3d6ab8d10a6ea3a20f40e7cd121cc57db7ff09faa738dddd3e1acd30d0a0a8f04abb4045983d189a1bb6b5c9721e5a19edbba9e9f4f9e967d13bf2f1f238a07ebdee05c7a405f3420066674c3a3bb10e6a123fed1b620214e1ae166b286804a02977cc2cadc3788dc5c7b29aca508221307a1bf670d2a8613fc4a6a1cbe0a5a4a0c8016a382a4d7b60aa1e183191385ff158939782826e490616cae49ec19bfd2aa047f06817e34cf3ac2d5fa8c08e9f406cc1cef22f18d2a838ab2413d6c472f8cea0567eb8dc4e3fd62e2dd4fe7f362610d64396522a5938150995aafa41db552bd7a067674c5952ee92b673b653670cb7673a2d9058b8c085b104b302e70f2e3b8ba6a0cffc85324a41da22ae10bf2f959a21bdf35ce0a86d9b353a3213bc0feee08abd80b90214f90211a070737e92ac36992e12e55908f3e479f52eefd6fd0264cd8c64fc314876ee004ba068b7ae6411deb5087d8734f84176d84e423ed82125f3afee2d33632bfb57a51da06e0bb2bbcd47c316a5f23e27758ed72fd3113ad33b5da9e4a3b4276dc7d16407a02b71ff19f84eab8eac0f34ac0db32eb036e10e60f38c9dec95d95ba7e3c1e270a021a05586d887f7fd1ba40f77680a028e21a73cc9f607c0a73459144683d6e1d3a05677429ee761bb620e93877928db883bef3e496c103f027dd829c05f7c7cb833a04b7600fc629db3e4bd4256dc76c175d23e3272e5f1f88d92f8e6072c1686b750a04eb6333c96e57bf1af389faec9cb24ed2039fccfe0e82e36bb0c82e205180ae9a0f6f2d52465c1426bd534e364c89b7d04dad11e9314f0187f32881db769406552a01ff646f94ef6fc06e4a9bff5cdae83b16f39ad0509e5eff68ae3da5a5bcfc8a2a0a0bfe0fb065cca4fae4622e4135afb7ca0d739e388ffeff35a986bc7c59996d7a064b9ddb74d7c76928dfe178ecc3bc4a78d371009aef58629b02bc1364defd204a02db45f9fc19dec19d0359e033aafdd6fccef8a8c3a52e6b1ef71f80e909a50cea0c7711b7df64f573a5dddf558024550a729faf408ffc7138f828c20cd50d6055aa040a639c922febfe011c55383a1c47680de78cb091ae6396aa5cda8f43f63df68a0b64dbf6a5916ce36f5cc3fbd42795e9be8162eeef88dd75ea2c808cd9982a83b80b90214f90211a0772d0ad4883a2aedbae23f886ea62552a26dfd755053e675f1132c6a7e99cfe7a043304fdd2d5a7eb48509e6938aea837389fb7c803ea6b21cf2ebf5ec951c93d1a07a06d0dbc59f03a63ff347b9a673a3a43e4009e1584c45fc0427d9a299f397c5a0976e949cc3dbec5f29443b381b2644b0d1b3728cedd4830ba30fc8a6fede4623a06b61065c66b4b22929d5505a4e435a4bf6c6855857eddf073e431936f0a4c22aa0dcea905fb0e03993b21c9416cb2c35b659ffe5e390305f75be382f4f9b019284a0b3ee645439142c41e95f9fa0ffafdb4b973aa52cfa27fa30226942f0e81618e2a08e9b5fe7321fba7130be46e804a645f8fa27e47f3b990a1ee7bc529194416aaba0adfce7af9db323fd14c301503c04aa2fb7d20d09a2dd069cce1b436e01a333b8a0b2d057c47e94c0cdebc5c240ed9b952021cf9a98ac30e14e44a905e2f6aa773fa04a43e51326ae6254f44688b6ef6d3a32ca9960d37352012f0ce624679640ce95a0bf06b4d7e77594d3ee17b1f16a4ea1db3a074b0c173c8626808bc40ccaeab29ba09f70d7a6e9200cbfd6a70fe0f08ebb0a00f3b1032427344ec9308c1216d8323da09d5b93a22795dbb8c6b0806a7f55e9cb1706075df4f51dc24bdcdbc2e95232b5a02e3fea0695251faa8416dcc812fd502043e66bb1e5311beb856e809ff88feca9a09849ad6ffe5b118a043ab57989fb2391176e539f2450280273b5103edca1a9cd80b90214f90211a02c81e867be7fdff7b5f233c529e97c9bece4935f345594b23a83b229ec66b3e5a073317fd5dbd378152618d8dbffda67e6a8b78a5d13531cc7a2e44226da608591a00e2bb0c7fda5c4e469a82ff657fba938c0859f2fea8cf28be134de30c00ba503a0c8e0d712282cc534cb8353ebf1a6f3a2e0c80c6e788b1167a8f010bea409d1e0a031c4e153ab17b860052ada00ff69f074be78d2ef397c2922f97dbc89e80a88f1a0d9dfc5314bca6464eba4013e77acb90ec43b52a2b3511550ba0911283e84d257a0ef3acff06ddc05e934bca95a13a7ad40f5d25ef5a5c29d67aeaf0bbe4f251fcfa08e4776493a0e4db5321cc98ef6cf4d11b335cb215e5b3975d160fa48e4e24d5ea068f6c2051418371012a1e9c4b4fb983a9c5e9f019d8f1bd584931081c968b95aa0c47fdbaee82912493966cc3ece18dcd6f516e1b02a0f8e969fb8b00c838b2c77a08d629d5b9d26e51a74e958c84230e24e9e99ca0894fb06968bc984286698f81ca047cb038cb3ef3012ecde9af0b2b98731c7aaf31925392d9b334307e39e12f3b7a08716dc103ebc83062ba53ed64d1d88a881088d058f08cd084f52c334d5731b25a097e5a69abef43de28500e5bb7f455f59533e8c15f4dc6af48959e92f92792714a00ea0f97e5aa671ad07dd6c8dd0ed7b34c2665c811ca804ee02ae8d9a0248d847a0ab929d896a7a63a468a889326a410fd6bcc7f886c078f738c8029c032a3c243380b90214f90211a0185e5f7f70d689132d27fcccad01547d497bbb07d343de317ba6ac2c1a80697ba07025b3dc2713927a7253f0f3e18cc7398b62157df121fc51c449f6e7df5260cca0f8a4892abe38e6cbef5b44c91f43289cf91caa9dc0f4b7469e1ac861e15f813ca08f25f8d92bb546cc336c8ae09421ec36d41d5aaffe7aa6839a0ab9839d989daca0ca33113b20adfa0801b90bfa0da97063fc7b111388720c3df95057ed209580fca0ca989fed9cf3c53ab5bf2045ce6ef516c7820ab8552f2a28d4ecd78d9963aac8a096128afbaee78a79798d6cbdeb35816e644b45ace9320027ac866ef38f8231caa040f9c9b82cc1e7612eea1c7b2b015082c95503b5be542811001e4f1e9f31c4aca04b6ce1d1bf4b348353450a4d68742dbeacf8d63ebd5fb8f1223a8fcf32abfb74a0fda4b57c9b8c60c8ef6a42549fc999da3487c60d47831b2ecdfcb2156154f80ba02710315307cd63f018408773601b5ef6d6ec98c384ad241d4f6eee77ffcbc5d7a071f3398a1c6c666b9fe6e3ab27b3b9338f72500ba7b86d6f0b95e0e32f8ba1e3a02a649a860d20f80dba3b7a5afc3c3b750b02427901ea62be0e8ea96e59eee947a07d06cb0fd57d984d238ea0d9a39d159ca973fa37172a9c3d56ebbaa6a12ea233a0f96acef81e73e137ab3ed1feeaa3aa6e0ee24133f2aabf6c5c2bfc7472d3f7d0a09d3c88ee1d859f1bd69eb545cc7ae5cca39cbdbd15c7169b43d0885565a1a9e480b8b3f8b18080a0260510957f0ae6d92682cd1bbf27fb4d6de3a0cb2886d08b43414bdde69a37aea06ac5f520ca2286ac172e29401b98a5a1e201862c2bbb2a930e48daa612cc62eb8080a08b5ae6f3c969e551b883759877f9cf1d397af64db3e6dc4a69437b7b0cfcdb60808080a071a0a29f09da2499bccc1f3f44713617fcf60c493e3f63432bcac3f95599bf138080a0f06e2e755e6443f8c592845a007bd56197ae81bbd55dc68e2e03a6c22814c98a808080b889f8879e2023b76d0262107041ef01f93aa86c725dbb04c54bf65d06384efd271601b866f864778084136fe9798470e2925380940000000000000000000000000000000000000000a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470";

    const expected = {
      nonce: 0x77,
      flags: 0,
      fixed: 0x136fe979,
      shares: 0x70e29253,
      debt: 0x0,
      delegate: 0x0,
      sharePrice: 1080156979,
      balance: BigInt("0x1c63ce9da9c5a902"),
      storageHash: BigInt(
        "0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421",
      ),
      codeHash: BigInt(
        "0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470",
      ),
    };

    await expect(
      satellite.accountField(chainId, blockNumber, account, af.NONCE),
    ).to.be.revertedWith("STORAGE_PROOF_ACCOUNT_FIELD_NOT_SAVED");

    await expect(
      satellite.accountField(chainId, blockNumber, account, af.BALANCE),
    ).to.be.revertedWith("STORAGE_PROOF_ACCOUNT_FIELD_NOT_SAVED");

    await expect(
      satellite.accountField(chainId, blockNumber, account, af.STORAGE_ROOT),
    ).to.be.revertedWith("STORAGE_PROOF_ACCOUNT_FIELD_NOT_SAVED");

    await expect(
      satellite.accountField(chainId, blockNumber, account, af.CODE_HASH),
    ).to.be.revertedWith("STORAGE_PROOF_ACCOUNT_FIELD_NOT_SAVED");

    await expect(
      satellite.accountField(chainId, blockNumber, account, af.APE_FLAGS),
    ).to.be.revertedWith("STORAGE_PROOF_ACCOUNT_FIELD_NOT_SAVED");

    await expect(
      satellite.accountField(chainId, blockNumber, account, af.APE_FIXED),
    ).to.be.revertedWith("STORAGE_PROOF_ACCOUNT_FIELD_NOT_SAVED");

    await expect(
      satellite.accountField(chainId, blockNumber, account, af.APE_SHARES),
    ).to.be.revertedWith("STORAGE_PROOF_ACCOUNT_FIELD_NOT_SAVED");

    await expect(
      satellite.accountField(chainId, blockNumber, account, af.APE_DEBT),
    ).to.be.revertedWith("STORAGE_PROOF_ACCOUNT_FIELD_NOT_SAVED");

    await expect(
      satellite.accountField(chainId, blockNumber, account, af.APE_DELEGATE),
    ).to.be.revertedWith("STORAGE_PROOF_ACCOUNT_FIELD_NOT_SAVED");

    await satellite.proveHeader(chainId, hm.STATE_ROOT, headerProof);

    await satellite.proveAccount(
      chainId,
      blockNumber,
      account,
      am.NONCE | am.CODE_HASH | am.STORAGE_ROOT | am.APE_FLAGS,
      accountTrieProof,
    );

    expect(
      await satellite.accountField(chainId, blockNumber, account, af.NONCE),
    ).to.equal(toU256(expected.nonce));

    await expect(
      satellite.accountField(chainId, blockNumber, account, af.BALANCE),
    ).to.be.revertedWith("STORAGE_PROOF_ACCOUNT_FIELD_NOT_SAVED");

    expect(
      await satellite.accountField(chainId, blockNumber, account, af.CODE_HASH),
    ).to.equal(toU256(expected.codeHash));

    expect(
      await satellite.accountField(
        chainId,
        blockNumber,
        account,
        af.STORAGE_ROOT,
      ),
    ).to.equal(toU256(expected.storageHash));

    expect(
      await satellite.accountField(chainId, blockNumber, account, af.APE_FLAGS),
    ).to.equal(toU256(expected.flags));

    expect(
      await satellite.accountField(chainId, blockNumber, account, af.APE_FIXED),
    ).to.equal(toU256(expected.fixed));

    expect(
      await satellite.accountField(
        chainId,
        blockNumber,
        account,
        af.APE_SHARES,
      ),
    ).to.equal(toU256(expected.shares));

    expect(
      await satellite.accountField(chainId, blockNumber, account, af.APE_DEBT),
    ).to.equal(toU256(expected.debt));

    expect(
      await satellite.accountField(
        chainId,
        blockNumber,
        account,
        af.APE_DELEGATE,
      ),
    ).to.equal(toU256(expected.delegate));

    await expect(
      satellite.getApechainSharePrice(chainId, blockNumber),
    ).to.be.revertedWith("STORAGE_PROOF_SHARE_PRICE_NOT_SAVED");

    const apechainSharePriceAccountTrieProof =
      "0xf90b6bb90214f90211a0e7615cc1a65525dcbe26e59fac6822fd3bd555af663c4c580bd8cef784c31536a0715132fc76d255fc7a8aebdf240b8568e33bed61fcbd13db95e057b25ee4199fa067eabbde6b28d98300186b627409c9c1d0c4f83d29aa9fca00657df26fb99b57a070c2526f2f783305f00a9559d780220e963e83b238d0b4c06604c36c6b6c139ea09849edeee1a769316786b848c5bfa444be3c568cff1d5985fc8b29f75258df6fa030fd041f6909484573737047e63792567e4daf95b93d98d60c70d3baed2990a4a09b620ab489dd1f05f4582f2dcfb387bcb632f1b5e8046486e1ee2c9ccc0a4c38a09ead1c3d6ab8d10a6ea3a20f40e7cd121cc57db7ff09faa738dddd3e1acd30d0a0a8f04abb4045983d189a1bb6b5c9721e5a19edbba9e9f4f9e967d13bf2f1f238a07ebdee05c7a405f3420066674c3a3bb10e6a123fed1b620214e1ae166b286804a02977cc2cadc3788dc5c7b29aca508221307a1bf670d2a8613fc4a6a1cbe0a5a4a0c8016a382a4d7b60aa1e183191385ff158939782826e490616cae49ec19bfd2aa047f06817e34cf3ac2d5fa8c08e9f406cc1cef22f18d2a838ab2413d6c472f8cea0567eb8dc4e3fd62e2dd4fe7f362610d64396522a5938150995aafa41db552bd7a067674c5952ee92b673b653670cb7673a2d9058b8c085b104b302e70f2e3b8ba6a0cffc85324a41da22ae10bf2f959a21bdf35ce0a86d9b353a3213bc0feee08abd80b90214f90211a0c6a45e7643678caeab67b2ba2b9c5ee63e68d246e79f13daa2bf5accf6f7d5eaa08942f14eeaa72cea4b1eac826656ba78277c740cc472e209e8ca42ba6e833221a0afbdd15b83feaffd4202571c2f92e2711861e4fdc63f0ae354bbcc40de251deea0ee76733b83cd882b7613c37669c8dd9226a6fabb7be1c03b1919b93ee15f8c05a04dbc2cede94421cb41db7cc988c5759037037e813deb31dea233349c16e73a3aa0a95d21dcd3140c9a1fbc897a3f38945d5b706e156e4019acddaf8bf708861c6ca04ffc8554acc7c0fcb97705475d13c84413f693dfe93123c65057d4bbb0c65309a07b57185e563cbb38b78f80264cb5af4d80f8552e2a041f882080e21da7de983ba04c9b1e3cf12d6431471e5e83c41184c41fa83878aef158fb96757db39b0a4584a08aaf3a7a1b88ce57e6e8bad22ed53286281c9a02e2311e38cdd9ba143c63e251a0aa88e180440ad40044f07bb62ab5ce7e9ba28ef1396eb14394c315cfe7a45af0a017d4c4a3d02d2ec585cc2a5f719cbf53caf358dbfa41c3d96dd60da6dd19096aa04fb77d6d3519a3e4d18a4d5c7b93e04ad4e37781625c6e21d7430dd1fb36562fa094dfb81a60d56a6212e3e4606abe8c4476cbfaf1a6eb5159190d79c37c052434a0f60bd9aebe842082a47b60ef69c0d2931062d2e8e027e0abab6e1cbe3d914eaca0d5405a4969797de7bee1f939a25a208cfd0d10e1ec3b65f9df91470954e1c0da80b90214f90211a0477f8a999f5ed4367b58cd35cc748db36cce4e409d209518e67d36cef11632ffa034a750ee2dd5e3696f1c885f2d84258e55ee7bc3372769c922fd331c4521a90ca0264a694f3048de28220ec57e683f8c58f51ac396d0bda5326b8c297e02c4f090a03e0ce7c0f2ef8ae1f0aa8ba240a8eef5ba3214d45ced28bb9a575afe050059d2a098e9dbaec1546ba3c66ed8d115db838d433ae5044cffc27a2674ae475bbbf783a0011777739811535a0614bb54029aecdd4e88117794f14905e10d9f67d9dd7631a0966b55dd70190fca36c2a57ebd4d14e72bf3dea34955cd2ab607b4ba21515f90a0918641e853e6ca4c67a3b4343ef8188cc117a128488bca7ceef3e19a922e8feda00c7ad82c54c554486ee656ef0852fa440eb5d51a51c6564d1138e4eae6cd47aba0e4865aad08b197acada368076566ab26888193c30ffa2286af6cd7971b26ca8ca0fa499b1b93f72dda4f55fef241ae0903117b3f78add2755db78c1862df7c9821a074cc5d0b88fafde98cd12861d5ccacf81a2f308ff0ad4a8e56635784fadab31aa0a4128b1b060b89be15391c21d6ea54ef1db0d44f479b80f1a52966806f306fa6a0a15c40e1b09ac8b1edeec582803d1b459c53cd3a7307a0ad704135cf0d5be29fa0791ac40922459e4c7254d3a3fcdb8750b95c52dadf8cac41ca049dac1d76f43fa061549225d7f527c1011a320fc49bbf8e7cb3fd59f6821a703a92ae99d8fe911d80b90214f90211a03c04d65d7bbc314e8826f8ee85c092d9cba69d28009026474d7e8bbab523ec1ea08fde3b47534d861f97c701834a161f2f2b3242d8f2fee4d37045bd76594276b7a0dfcb522a5fffc7c1423e737b09df3696b3d39a546c442a932f0ce79629eaaba3a0d4c01cb806525b30a13f425550dfddefdcf47b9d1c4e0312bd149e05f86aa51aa02bdaea26637046c4eab9cc911427785154765cdafc0f00c6f1defcea57a35118a091b22d1063e9afcf048d47d006b2a06e96d7a3e5d516110a5db62a6fa3ab5a11a00845128608baf13cb7ea7895864abccbc4507f9f62a9c23732f5f26dd275c490a06732f6def5bfd950de6152b15a3beedc8c6f8ff5284d3454c604b56e83e7057aa00d8686518436272f33a41eb2d080eab49d70b8f7f6aa6e846ed2e3e0418171efa004f8a7b65cef7d3e93287a98c821d748697647f78559228dda6c439dbbc0ce76a0626e3616069f2204984b2f0ec555efd50136986bd0a1646729baf0501b6b36bca00674f2009540c3eb5cebfe2305daeec3bfc0ee8f4b3d38c043167ac0d1bb4cc2a015332ba3a2b62763daf1240f7fc8aacaec4093ead0b25ed6e2a93f89fc7890c3a0cd5cdef31151355c139dbc5cbf22cf010b00d5e2dca3ad0f808d4aa963432681a0223a62ec93fb0dccfdd560aae6802791dd8e5ffa4c6073e8099be03dfcd479cca070e8d4d01b8de4991da41f17f309d37421939a6e42a73464a631a335fbf8406b80b90214f90211a07f44fe4608ed9923ffeac170269c74faf23e824617ce8285c8b95de01f12bb15a015367127ae31f6ca4633a71cfe8135979e6c3cff0ba49abb44d46cb894f72028a064d98ecb4b285cf2c528d395a7a735ff85d83583eaa0f9e0dcfd3172ef769a15a0de42e90609f66ca1ca8101cbab77a1a773519de5dfd408533df239cf1864dcc9a0f4b85ec281f3c4f09879579cc0bea45eeb6b599584b130994e109a43c664b463a055abd4a9efb67dcd863a9597e4c7ccbdebc1d60542b12f920603775e63acdceba0051e9e0655f35890747c09af7c4b9fdcb7c1b6a08f5da375715fb10b9b3e6d2ca0fdd740415e090e4294c6e9f0d34784ba9dd99a66d56e2764f4bdee8769d66fdca0e25e7d9adbab2fa55cf97426759a44178e87ce0c42120e6cb0adb00dc3e3a7c2a0b413b05fd5576bf2bfab305ff61f286929593226bfb255f259e2220b61c154f6a01bf41016b8c1a8fef48ea631332da70d596bd73d2f2fd69f007d39eaa2dc5f54a0961264770fcb1e1bbcfb30cdecd04d37e503430ab21928b7cde9f3b18036c081a0b1fcae7cc5cd15e9557ea67888c98f29c507e90589cd5bff982633582b7ed9c8a00b571955a1ceb3e23d9a4ca307d48eb2b8a525c1bd504cabeb54f07bb209402aa0a290132dd983c4e046e72fa74268f4c35f90f15cc3b82099470ca3b9a3153651a03b74c9957aa75b117aada236db299110c03ef8c0bc2ca2fe953e6ea602e83e7080b873f871808080808080a0b0d91d4bcd5121bd936dfaf310d6c7dc0b4c9922b13642accd9d913304dd62da808080a00fe4c37bd8dd301accf06702dbfadb09860ea0e86c1a33665e12646abf722313808080a01ee632dca6859758322e01908a13d7f86ccbcc27a706ee3115d68a2afa81f0a38080b881f87f9e20c89c201c23aa60e231e3993b3966b33ff1f55d198ec25980957ab32065b85ef85c0180808080940000000000000000000000000000000000000000a0febbcdc0e5f7973de7ffbfd6c9791f2592ddce81ee65b46301100f4551647aaaa0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470";

    await satellite.proveAccount(
      chainId,
      blockNumber,
      APECHAIN_SHARE_PRICE_ADDRESS,
      am.STORAGE_ROOT,
      apechainSharePriceAccountTrieProof,
    );

    const apechainSharePriceSlotTrieProof =
      "0xf9044bb90214f90211a081f956c3454b047ce1187ddd8075ced3b95dee83cfcd9913a1d467d43e2801bea0c3c7b71a264e6588377cd8eb99d5c9e574c0e880d01f813a1c9aca49f454173da0663900b3cd1a2b18a11d46c1b04e6a2b8c2008dc0a7a8a8fa60df21427896a4da073a642ff25c0fed16e64e5698e62a448e06f2ad9682f340e5a0219bec40b011aa037e6cf1046e134c4b761f29a61586e18e3a217bd1164ced40bcabd1517f0d93ca0e31553ad561cb628813228235026734a2fb9afe33935f95514bca0a59c0b36e7a078a6f0f15a51691098f3750f6b0dbde24497b53c73d5bb7bb9c82ca2866b2cd0a0eb105069f3a5ff3f4df19982f8cd4052bb1821522aa1905bd8f90e486ede3538a0c6d6f10e2005e5708175061662cfef46e3d533ab6fc0d9467e4b1b079babd061a0b38acdc6747941ed58e25e5624568e2b6600a531260e40e65157ef095d3cedb6a0a6d5a2a6b31d07bb63dcd74a8947f6f8d7ba02acac7ddbeb58dfd3ecfa3daa65a0e45ad5268ea34bf5738d3fc7e0b27687ce18b535069e0c701884dd3b0187507ca05e345a488173c6a380fe14387245ce52b158bc26cbbf00bcb9978003e9b82f57a033c4b1d0bbe769318784056b9e31004c6631b5607448736bb22999bbea9366a1a09f2e5581f6e3155eb32ff763c83a1be138c95987f90aa4505171f40ff4ce6bf1a0e74070dd7edbef17fbd78fc8a39efe58afa1a38d4eef07594eb6cc10180f80dc80b90174f90171a01ad3d0947cbe490eaffcddc78b52ad528d0663522f4e8331a27f38afc5dd78a3a0f7b3915b05268ce1fd08a4777230470663bd0dc373b0086ec65d1d93e3e12620a03452d3f42ba5128ff0eb4f016d9bc3c7e22816a55afefc929552c35bc1f0b618a073d56783f603ad5249d684aa6d3d6031b5c2260924f9722e949fdf3b1bb4519f80a0031cf06429de0b5ced6ce511efdfc53bf94a83665ab13161b71cf4e45d64630ca0ed96e66ffc46f9d80c6c076129ccd70620ce4055770d9f2ebd3360e06f47291ca0db0ca3628ce590497baf35d7306f20a09869d6b2f48cd1612eeb1f87defb6a898080a0eaa71bc63181e92b680b683c02044628fa98cae5383b3e49ac924bd3ce2920bfa01f12db2a888a494013cb1e02d1d41e43fcf96a73ae78d1376757215e27c8d447a01cfcc402bcb343579a9a79f4fd9e2375420d730f91d67bbda5e6b2fc5e68e93980a0ab8becd9e9ecfea4d733c3d2ee8a176b6739c02bdda0d552947318946cce9a878080b893f89180808080a060cc480c49176601f6a6d16bed648fe0cb126fb724d158c39202ee8b8757523c80a0227047ebc9eb3b51242d50b7bce9e6c5a9008fe80eecd360d2815c632c1c4c5f80808080a0531701df437ea64b7dcb1f56e470996d5d1f1be88cd62df082e899c974a5a766a00d2abbe2915038a7197c75eb2401ab03d5c5aa675fb3a3ecb41ffb4b22e5c56480808080a7e69f3e8e3c05535dbd410940d5afe7658f6c3d4ab028de9daa6ed96018e75663f085844061e333";

    await satellite.proveStorage(
      chainId,
      blockNumber,
      APECHAIN_SHARE_PRICE_ADDRESS,
      APECHAIN_SHARE_PRICE_SLOT,
      apechainSharePriceSlotTrieProof,
    );

    expect(
      await satellite.getApechainSharePrice(chainId, blockNumber),
    ).to.equal(toU256(expected.sharePrice));

    await satellite.proveAccount(
      chainId,
      blockNumber,
      account,
      am.BALANCE,
      accountTrieProof,
    );

    expect(
      await satellite.accountField(chainId, blockNumber, account, af.BALANCE),
    ).to.equal(toU256(expected.balance));
  });

  it("Should prove slot inclusion and non-inclusion", async () => {
    const { satellite, satelliteAddress } = await loadFixture(deploy);

    const chainId = BigInt(33111);
    const blockNumber = BigInt(18179561);
    const mmrId = BigInt(100);
    const mmrSize = BigInt(1);
    const keccakHasher = BigInt(
      "0xdf35a135a69c769066bbb4d17b2fa3ec922c028d4e4bf9d0402e6f7c12b31813",
    );
    const blockHash =
      "0x7a065a738bebe14a0ae2b8088f892cedcd4da1d0a2b254b2ab5ab2e25e15ed4c";
    const mmrRoot = BigInt(
      ethers.keccak256(toU256(mmrSize, BigInt(blockHash))),
    );

    await setMmrData(
      satelliteAddress,
      chainId,
      mmrId,
      keccakHasher,
      false,
      mmrSize,
      mmrRoot,
    );

    const account = "0xDd6B74123b2aB93aD701320D3F8D1b92B4fA5202";
    const headerProof = {
      mmrId,
      mmrSize,
      mmrLeafIndex: 1,
      mmrPeaks: [blockHash],
      mmrInclusionProof: [],
      blockHeaderRlp:
        "0xf90223a08571c2009f6a83c25db0ae82d55c90fab2746b2d98bf1bdbd9897102340c18bda01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794a4b000000000000000000073657175656e636572a0245ffbfce31bb2055eaa111c2f4352ba565df297d42caaae850ebf01de3e923da0d768317e2632e07cd80f41d9db7b9efdc9e5749fbd9a81634a7ce0cd6d138bc9a03b94b85217f4a6d952a869965b6473df5b37ba5f6d2b1d1e382e1aba232f8fbab90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000184011565e98704000000000000830186a084683ad0c8a0875dca2e0fa616d72c55138ddb45cdee89038acb254f9c1b7a602d335b0b7c79a000000000004a12df000000000080de5b000000000000002000000000000000008800000000000e5b3783989680",
    };
    const accountTrieProof =
      "0xf90bbfb90214f90211a0df605693bf81483301b303cb876e5ae4c17c3ea38ecddf53a74005874d1deb0fa017773397491e3c9cf21f6c3b6e57566456579dcfc39df217157a52e410b34fe6a0de124311060292d26a41f1662999fc951edd04ac0978dacbcae83a21fd13ae6fa09077b4ea34c2c825691a7c1e0a088ab5a60c1e123590786337cfe24cb5bce554a0c12098fde59150b349a1a8dc1acf960aa36c5c2cd632217152c756435c37c9e5a083c2a472f7339e407fcc4c76ff9dda1eb579155cd391c11f0f108992cd2b0150a0852ef54d10bf83ad59a7e85d939a0f02d47f8a4f024b0ed5b796361e0837dfffa06a4ae59d966c9ad3244ec1f31f50ff947e747d53735d815f66c0a8a788e1b29fa08125163de0a539d69d556dc30276fb84e1c0838439b81d3b2f64434576eee8c6a020024225fd4e5068175b531a3266694a56268597a0eff7bd1df6965626fd54c8a0740f6326360caac44389848032c6da58fe5dae853ed15feae6eb240a67c1f06da0ef12bd27ba2fbc79500e8c17c8cb440ef78107c790d59df1c472bd7ab804e2daa0a4665b912cb2f9cf5a0a2c4e83c89bb6170d6ea2f711f78dceabab108becaea2a07577b25d545d7552fada72316fa91413aae37d6450cb26a085fc60a01b904fb3a0954cc7def419abb72ccdfa8c6bb969c181c3eb020a0b033f34fee556aef5cae9a0b0e159f0d95ef32ebcd186900cd5fdf5e737a9cd7df96dfaecd5f88bad42b84e80b90214f90211a00986824aadf720c47d34dc217c2c244dab3e647346cac6645785597793f8f5d5a0f0f1835cac29ccd959d775438b3ce4f1374401bb99ad48c696231402e1a708d2a02038a9c3c5835c25777c9dc60a5bec264fe715b57b3b67da7c5c4a90dcad0aa9a098edf0dc565f503b77e3b6524ab225d13868ff0fab75175320ad50239857a1faa01634f481f1c12cd5f2f5c3ee4276316c7ebf42abafb7cc963e5ea499d3c5361da053c2fe691b71dd4f358b7e92eb7ac19188aafafd822d4b201a0dfe59f1291d2fa0d5379fce498b32ecd094ea71361c4995a826951c8b0e8b33aab40115c5649fa2a070ea0992d283b0122407bf0629e37a950af505d9534902e4377a29737851a9d8a03dff5e0a3c4d7b55cb486b5b96be88e53210103722e32e6f839fe9c88c22f384a07bd261b2a62115c987189a77527062757fe561d34a8ab9243c5cab0725847c5fa0bc6e2900a585713280aa31d55b22990d20be6af251eb702cf57c6209b9a03ecba0d0af22d41d39cf00a5910cd2a1f183a8f9639c7e48a0701df84d2b425a0559e1a048b4b93539ceae4e5d31952656acc682e457a885557a053bee542502cb57cd55a0843affe8e3d4bdbc2d0d8632cd39f23aed1acef2bd65a7318750a3fbe811da64a0839adf77858337b0a1a330bf7e3a2faf4d276a75e76a89d96265d89756e44aafa088e10001687164f6588d9240f199f86f9e2cb05975aef0f6d5634b2dfde744eb80b90214f90211a0f396972247181410be770f4879296c3ad3515587e83c9472b124c6cc28906479a0be445ee0e3197e76e4de1562fb44db47ac0980a98a83d506b09ecd3c3af63ae9a02a32e75d3608d4fddd7c73c669763ff45301df5e87225920e9965ad3bd5aee1fa007be23b1ab175f232ed9dd8ed381b6659c6199b26f762bfe20f67533357b6c54a0c58c33655ecc93f814f0933c8012e703dcd10d454a7af6b49859b789e1f3f5c3a03bbd68fa704bfb367c38be823556e535dd9a4755dfd159eef26eb04b37dea703a0b4465e81f7e9a9f26927e487b786444e2e8c2cf1e2e953579aebb6fdc5a72bbfa0d83c29ed41d77f71f9baf62c5d99ed82e6da83def632019d2eb328672f999f4aa056730e8be678ba8c4f9b109f0d779571fdd06e6432cd6b96fe3c7e4d64f7d173a08a73d46b10d43dcd02c66d7701ea1bfc188378da01a0b3f593096ab7a780131fa04a18f5d9675c5f1ea5bd6f15f97dfe83e14c7f7204774ecc0f4d2372fdaae371a06d50197726d02f6ca02d87f56c03ef105cea6eb90c8e51846b49058dc5b793c8a078b2542bad3c3362541eaf082b4a7a9874cffd42e7a381a504706311316e37aca0a40d0ffa382958005c36bcd0c767c6bc58048d972954ac6486d99d20eca99754a0a120fab18c5ab12fa17f1cc7f9e6221a0e9fb874033a92e4ddeda80a2b50b248a0821890a91e96e43fa1245e6203934047f491010a2ab313a118f84a6642dcea1980b90214f90211a05be24c7faec8b87eb21872834206da609fe0fece40536a5c0203fbb6f85cbab9a0850d574a3b8e423600fdc2800de4f5c28c137be2e556cdbe4da5ac8628f5625da07d5c8cff70e90a8a925b1a8f3a00bad96e8d28784fcad31a38322e553741f6a4a021f49d95af116caa5da169e9e3aaad9a1b2881bc5676db8482750b5a4d4ac415a05affdb0f9e9920c321cc662dde8d8f6301ee83ed18604b942a5cddfb8ae5febba0207db7ea9377af7166ffd39ab54af792fddcc2e84570f74f570dad45de9645eaa0c86cbbca012de369d15cf720dae3d9f003686659d1990b2ab7eb434d1f27b615a0b7ef76bb24add3eb011c43bea6d672365fc3cac5680ef5621643522fff8b26cfa0da9ae48f85cd1add5405c65b5c8d6c433d11780ece884d50046295410d20384fa0bf35ab5c4d0d78478322ce819e064c008fd21e1b406cc99cb89e478149a7c389a0bdd98bd5ea7280e3136685c9f21d559bad97b6f6fa99bfd6229164f6d98f63b9a028450f498a9e3f016d4b7e538fa45bb573f2201eab2eba536843c375d2de4589a015a0b524930cd13052191b4aef60c31e40ff90e58e63e4685087f92dd42875d4a0152ada8443ecab620f0bdfe3a71e251fb0ef229d6b114f4d1d9706c71d34106da081e47e15ee4c5a14502222d46798d7c7fe17cbb1430bff99855018c8f4ffa4f5a0b8cd81c17ea80e6d0e412e8c343dd5f4f794f8790834e7758832c128e8f797f280b901f4f901f1a0a0558f3db427cefd4d0e38a52c9605845853889f44381bfe642fbca7d3e901b9a07ba05819b976afa90c6b3b9b1b1b379b9aef725f26f089a5f4cbf4f08855e159a030cf24b3bb345fcd2157eef1d8fd41b98f95d05147721b7978adf809d6bd3196a0dd52b7267ecfc7578e84f5f031e864f26abcb93f8115f18af76949c1129ee09fa020df708785c6242bf6b852061fbcf8b5e897a7dcc350f0141ebd35804f2fc637a013ccf2685eb0de75d8828fef4fbeee989ee7962328027c409fed35a468941e90a0276cc1f23106e7e970aa6fd551213a0a55733be435cdf2b257f067d9c5599dbca076a35b4d014a28e886ed6e8265d918d5ceac3451f9b0c1739990af07f464a13fa0096250ee479cc9805a28453deb9af1db62709172f9fa4b8a9dd4c45f9dec39a4a0ad40174d8bfa392ca90df943e995bba99c30c21a8c23f20cda9b1c7c6186a976a083190aaa798580dfeb115d1f769d029de36fc8772b034abe06dbb4c70120afb3a04b004e46ef3be124c2b92e9793ea4d5940a90c34987e4991a84a6d4956c2e6bda002914473938c277aa81ccc21b04eb1b370f30c7698ec327ba1d18ef793eb9df380a06802dc13351b5dcb61e1e7eb1ac58d80e8203bcced29b60540303474398d3624a06dc18140a33ecf80433a06a6173282d1591d205eb1434c7c3853f84c12576d0680b893f891a0c0b6f5bb991164e80600344e60e47fe00ae732a06549a9c8887ea65902bec6278080a00ef1cb224c45f1c229e46fae1a867608af7da27c10732cf2d7b72e793d2cf474808080a07a8827a756c391465db7de64d261a6dc8c8bd617dd8efa752ab54e6b3e2429e9808080808080a08328bfcd7b08294659849e5ed20e8bfc6ac40db5043f041f9d74957e7d8a17588080b853f85180808080808080808080808080a0d6f62af115a1fa7a9046b1dee649f50d0e5d210440cc4a8660d60b0ac11e03f280a049f1598cd8b5f68707c37b4efae7cdc791abbffae9e760adb6dc41f1a73c52d880b880f87e9d3e60998274632b32e72691016f279db9d2cc367c87e64c3a0044131c1ab85ef85c0101808080940000000000000000000000000000000000000000a06fe522ff20ea9af8b6e98a87ee84a24decfe5c7a667d3aaeba27e0e9b343bc7ea01800dfc8f6947634cee2a1dfa6fe2b046f03818e209b968607d6c6315ea0926b";

    await satellite.proveHeader(chainId, hm.STATE_ROOT, headerProof);
    await satellite.proveAccount(
      chainId,
      blockNumber,
      account,
      am.STORAGE_ROOT,
      accountTrieProof,
    );

    const slot1 = {
      key: "0xcc69885fda6bcc1a4ace058b4a62bf5e179ea78fd58a1ccd71c22cc9b688792f",
      proof:
        "0xf90210b90174f901718080a084bb0c9e8dc9c92f5db825e7fac16697c717b876d756a75ace3ffa5f2ea0edd7a02dc9dca7a7f5d0ff9a6070fa0efdb6bf7c123ba527f0db8c7485f69435aa0c4fa053efa25abf807fee5a339f27ef43c66ddea8dec16f926b81cc236c6f6c1d962ca01c07915e26521984891ec54d34ad0755c1a72e2fa87c5f4a92273142ecb628bca00cbcc427ec08890b4f339b43bdaf6d6faeb8f98ea90729ceeda87b6ae6c3ad9c80a035fb0e74442c3f9a95f71575ddb25c9a6649a079d50bcd18622c1fa1f89ad235a09a2c5736b9c61331e0d3ee1f03ad3a3bd0ac67d489cf453692a118387bc4e38aa0c66d63869c4eb7e3331e69f54b28b4a7c52e52475df11509d07b082dce2f0574a0926c6931b65904f8bc80160e40a2961fc408edaa68000140324236a85c2396828080a02c630d118588b1bc9c42eeda9b0b24a7f77f3d604c1b8770aa6f1008871ff754a08144608a11e22b51b3b26acce79a8902525474e577e321f3371cde00051a181180b873f871a0247b608198f1842abdae36f0fd1bf8c8dd133117fff28f27b74413f06cfef2638080808080a0118cddee28e2ed006f3119bbed41e10054f5a29bce0aa2b1a0460bb440fae70580808080a0009a90797d66f8b3bf79da08ea56f2e83b4b1dcc2d671580dfa987bb1e7a6ac28080808080a3e2a020b32740ad8041bcc3b909c72d7e1afe60094ec55e3cde329b4b3a28501d826c03",
    };
    await satellite.proveStorage(
      chainId,
      blockNumber,
      account,
      slot1.key,
      slot1.proof,
    );
    expect(
      await satellite.storageSlot(chainId, blockNumber, account, slot1.key),
    ).to.equal(toU256(0x3));

    const slot2 = {
      key: "0xd9d16d34ffb15ba3a3d852f0d403e2ce1d691fb54de27ac87cd2f993f3ec330f",
      proof:
        "0xf9019bb90174f901718080a084bb0c9e8dc9c92f5db825e7fac16697c717b876d756a75ace3ffa5f2ea0edd7a02dc9dca7a7f5d0ff9a6070fa0efdb6bf7c123ba527f0db8c7485f69435aa0c4fa053efa25abf807fee5a339f27ef43c66ddea8dec16f926b81cc236c6f6c1d962ca01c07915e26521984891ec54d34ad0755c1a72e2fa87c5f4a92273142ecb628bca00cbcc427ec08890b4f339b43bdaf6d6faeb8f98ea90729ceeda87b6ae6c3ad9c80a035fb0e74442c3f9a95f71575ddb25c9a6649a079d50bcd18622c1fa1f89ad235a09a2c5736b9c61331e0d3ee1f03ad3a3bd0ac67d489cf453692a118387bc4e38aa0c66d63869c4eb7e3331e69f54b28b4a7c52e52475df11509d07b082dce2f0574a0926c6931b65904f8bc80160e40a2961fc408edaa68000140324236a85c2396828080a02c630d118588b1bc9c42eeda9b0b24a7f77f3d604c1b8770aa6f1008871ff754a08144608a11e22b51b3b26acce79a8902525474e577e321f3371cde00051a181180a3e2a0325f15e3234160087bc979c46f3dfd2f4881ae296f6d41799db3e0cb083540cc01",
    };
    await satellite.proveStorage(
      chainId,
      blockNumber,
      account,
      slot2.key,
      slot2.proof,
    );
    expect(
      await satellite.storageSlot(chainId, blockNumber, account, slot2.key),
    ).to.equal(toU256(0));
  });
});
